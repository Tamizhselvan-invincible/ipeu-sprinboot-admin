name: CI/CD Pipeline

on:
  push:
    branches: ["production-ec2"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Check Out Sources
        uses: actions/checkout@v4
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Create Firebase Configuration File
        run: |
          echo "${{ secrets.FIREBASE_CONFIG_FILE }}" | base64 --decode > ipeyu-firebase-admin-sdk.json

      - name: Login to Docker Hub
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin


      - name: Build the Spring Boot application
        run: mvn clean package -DskipTests

      - name: Build the Docker image
        run: docker build --build-arg JAR_FILE=target/iPeyu-Backend-admin-1.1.0.jar -t heterophyllustechnologyllp/ipeyu-backend-admin:latest .

      - name: Verify Image Exists
        run: docker images

      - name: Push To Docker Hub
        run: docker push heterophyllustechnologyllp/ipeyu-backend-admin:latest

  deploy:
    needs: build-and-deploy
    runs-on: self-hosted

    steps:
      - name: Create .env File for Docker Compose
        run: |
          echo "SERVER_PORT=8008" >> .env
          echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" >> .env
          echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
          echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
          echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" >> .env
          echo "AES_ENCRYPTION_KEY=${{ secrets.AES_ENCRYPTION_KEY }}" >> .env
          echo "JWT_ACCESS_TOKEN_EXPIRATION=${{ secrets.JWT_ACCESS_TOKEN_EXPIRATION }}" >> .env
          echo "JWT_REFRESH_TOKEN_EXPIRATION=${{ secrets.JWT_REFRESH_TOKEN_EXPIRATION }}" >> .env
          echo "PAY_SPRINT_BASE_URL=${{ secrets.PAY_SPRINT_BASE_URL }}" >> .env
          echo "PAY_SPRINT_JWT_KEY=${{ secrets.PAY_SPRINT_JWT_KEY }}" >> .env
          echo "PAY_SPRINT_AUTHORIZED_KEY=${{ secrets.PAY_SPRINT_AUTHORIZED_KEY }}" >> .env
          echo "PAY_SPRINT_PARTNER_ID=${{ secrets.PAY_SPRINT_PARTNER_ID }}" >> .env
          echo "SCRIZA_BASE_URL=${{ secrets.SCRIZA_BASE_URL }}" >> .env
          echo "SCRIZA_API_TOKEN=${{ secrets.SCRIZA_API_TOKEN }}" >> .env

      - name: Pull Latest Docker Image
        run: docker pull heterophyllustechnologyllp/ipeyu-backend-admin:latest

      - name: Delete Old Docker Container
        run: docker rm -f ipeyu-backend-admin-container || true

      - name: Run Docker Container
        run:  docker run -d --name ipeyu-backend-admin-container \
             --env-file .env -p 8009:8008 heterophyllustechnologyllp/ipeyu-backend-admin:latest


